"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[836],{6836:function(e,r,t){t.r(r),t.d(r,{default:function(){return C}});var n,o,a=t(7437),c=t(2265),l=t(7776),i=t(8938);let s=new l.USm(0,0,0,"ZYX"),u=new l.Pa4,d={type:"change"},h={type:"lock"},m={type:"unlock"};class w{connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}moveForward(e){this.isLocked&&(u.setFromMatrixColumn(this.camera.matrix,2),this.camera.position.addScaledVector(u,e))}moveRight(e){this.isLocked&&(u.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(u,e))}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}constructor(e,r=document.body){this.camera=e,this.domElement=r,this.isLocked=!1,this.pointerSpeed=1,this._onMouseMove=p.bind(this),this._onPointerlockChange=f.bind(this),this._onPointerlockError=g.bind(this),this.connect()}}function p(e){if(!this.isLocked)return;let r=e.movementX||e.mozMovementX||e.webkitMovementX||0,t=e.movementY||e.mozMovementY||e.webkitMovementY||0;s.setFromQuaternion(this.camera.quaternion),s.z-=.002*r*this.pointerSpeed,s.x-=.002*t*this.pointerSpeed,this.camera.quaternion.setFromEuler(s),this.camera.dispatchEvent(d)}function f(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.isLocked=!0,this.camera.dispatchEvent(h)):(this.isLocked=!1,this.camera.dispatchEvent(m))}function g(){console.error("FPSControls: Unable to use Pointer Lock API")}var y=t(9733),x=t(1648);let b=(e,r,t)=>{let n=e.distanceTo(r),o=new l.fHI(.5,.5,n,32),a=new l.vBJ({color:t}),c=new l.Kj0(o,a),i=new l.Pa4().addVectors(e,r).multiplyScalar(.5);c.position.copy(i);let s=new l.Pa4().subVectors(r,e).normalize(),u=new l.Pa4(0,1,0).cross(s).normalize(),d=Math.acos(new l.Pa4(0,1,0).dot(s));return c.quaternion.setFromAxisAngle(u,d),c},v=(e,r)=>{let t=r.geometry,n=new l.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.heightmap.length-e.townSquare.y]*x.Vl),o=null;if(e.docks){let r=new l.Pa4(e.docks.x-t.parameters.width/2,e.heightmap.length-e.docks.y-t.parameters.height/2,e.heightmap[e.docks.x][e.heightmap.length-e.docks.y]*x.Vl),n=new l.Pa4(r.x,r.y,r.z+10);o=b(r,n,65535)}let a=null;if(e.temple){let r=new l.Pa4(e.temple.x-t.parameters.width/2,e.heightmap.length-e.temple.y-t.parameters.height/2,e.heightmap[e.temple.x][e.heightmap.length-e.temple.y]*x.Vl),n=new l.Pa4(r.x,r.y,r.z+10);a=b(r,n,16776960)}let c=new l.Pa4(n.x,n.y,n.z+10);return[b(n,c,16711935),o,a]},k=(e,r,t,n)=>{let o=t.geometry,a=new l.Pa4(e.x-o.parameters.width/2,r.length-e.y-o.parameters.height/2,r[e.x][e.y]*x.Vl),c=new l.Wid({color:16773358,roughness:.5,metalness:.1}),i=new l.fHI(15/n,13/n,2/n,32),s=new l.Kj0(i,c);s.position.set(a.x,a.y,a.z),s.rotation.x=-Math.PI/2;let u=new l.fHI(.5/n,.5/n,10/n,32),d=12/n,h=[];for(let e=0;e<12;e++){let r=e/12*2*Math.PI,t=d*Math.cos(r)+a.x,o=d*Math.sin(r)+a.y,i=new l.Kj0(u,c);i.position.set(t,o,a.z+5/n),i.rotation.x=-Math.PI/2,h=h.concat(i)}return[s,h]},P=(e,r)=>{let t=r.geometry,n=new l.Wid({color:16773358,roughness:.5,metalness:.1}),o=new l.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.townSquare.y]*x.Vl),a=new l.DvJ(1.2,1.2,.1),c=new l.Kj0(a,n);return c.position.set(o.x,o.y,o.z),c},E=(e,r,t)=>{let n=t.geometry,o=new l.Wid({color:16773358,roughness:.5,metalness:.1}),a=new l.Pa4(e.x-n.parameters.width/2,r.length-e.y-n.parameters.height/2,r[e.x][e.y]*x.Vl),c=new l.DvJ(1.2,1.2,.1),i=new l.Kj0(c,o);return i.position.set(a.x,a.y,a.z),i},S=(e,r,t)=>{t=Math.min(Math.max(t,0),1);let n=parseInt(e.substring(1),16),o=parseInt(r.substring(1),16),a=n>>16&255,c=n>>8&255,l=255&n,i=Math.round(a+t*((o>>16&255)-a)),s=Math.round(c+t*((o>>8&255)-c)),u=Math.round(l+t*((255&o)-l));return"#".concat((i<<16|s<<8|u).toString(16).padStart(6,"0"))},M=(e,r)=>{let t=e.heightmap.length,n=new l._12(t,t,t-1,t-1),o=[];for(let a=0;a<n.attributes.position.array.length;a+=3){let c;let i=Math.floor(a/3%t),s=Math.floor(a/3/t);n.attributes.position.setZ(a/3,10*e.heightmap[i][s]),c=new l.Ilk(e.heightmap[i][s]<.001?r.terrainGradient[0]:e.heightmap[i][s]<.5?S(r.terrainGradient[1],r.terrainGradient[2],2*e.heightmap[i][s]):S(r.terrainGradient[2],r.terrainGradient[3],(e.heightmap[i][s]-.5)*2)),o.push(c.r,c.g,c.b)}n.setAttribute("color",new l.a$l(o,3)),n.computeVertexNormals();let a=new l.YBo({vertexColors:!0,flatShading:!0});return new l.Kj0(n,a)},F=(e,r)=>{let t=e.length,n=new l.Ilk(2237149),o=new l.ZAu,a=0;for(let r=0;r<t;r++)for(let n=0;n<t;n++)null!==e[r][n]&&e[r][n]>a&&(a=e[r][n]);for(let c=0;c<t;c++)for(let i=0;i<t;i++){if(null===e[c][i])continue;let s=e[c][i]/a;if(s<.05)continue;let u=new l.zf8(s,4),d=new l.vBJ({color:n}),h=new l.Kj0(u,d);h.position.set(c-t/2,t-i-t/2,10*r[c][i]+.5),o.add(h)}return o},z=e=>{let r=e.length,t=new l.ZAu;for(let n=0;n<r;n++)for(let o=0;o<r;o++){let a=e[n][o];if(null!==a){let e=x.nK[a],c=new l.Pa4(e[0],-e[1],0).normalize(),i=new l.tGC(c,new l.Pa4(n-r/2,r-o-r/2,12),1,11184895,.2,.2);t.add(i)}}return t},R=(e,r)=>{let t=new l.u9r,n=r.length,o=new Float32Array(3*e.length);e.forEach((e,t)=>{o[3*t]=e.x-n/2,o[3*t+1]=n-e.y-n/2,o[3*t+2]=10*r[e.x][e.y]+.2}),t.setAttribute("position",new l.TlE(o,3));let a=new l.nls({color:16777215,linewidth:2});return new l.x12(t,a)},D=(e,r,t)=>{let n=new l.ZAu,o=10*r[e.x][e.y]+.6+.4*t,a=Math.random()+e.x-r.length/2,c=Math.random()+(r.length-e.y)-r.length/2,i=new l.fHI(.02+.05*t,.03+.05*t,.5,6),s=new l.Wid({color:9127187}),u=new l.Kj0(i,s);u.position.set(a,c,o),u.rotation.x=-Math.PI/2,n.add(u);let d=new l.Wid({color:2263842}),h=[new l.b_z(.25+.25*t,.15+.15*t,5),new l.b_z(.2+.2*t,.18+.18*t,5),new l.b_z(.15+.15*t,.1+.1*t,5)],m=[.1+.4*t,.2+.4*t,.3+.4*t];return h.forEach((e,r)=>{let t=new l.Kj0(e,d);t.rotation.x=Math.PI/2,t.position.set(a,c,o+m[r]),n.add(t)}),n},L=(e,r)=>{let t=r.length,n=[],o=0;for(let r=0;r<t;r++)for(let n=0;n<t;n++)null!==e[r][n]&&e[r][n]>o&&(o=e[r][n]);for(let a=0;a<t;a++)for(let c=0;c<t;c++){if(r[a][c]<1e-4)continue;let t=Math.log(e[a][c]/o*(o-1)+1)/Math.log(o);t>.3&&(n=n.concat(D({x:a,y:c},r,t)),console.log("Added tree at (",a,", ",c,")"),console.log("ret = ",n))}return n};(n=o||(o={}))[n.FreeFloat=0]="FreeFloat",n[n.FreeFall=1]="FreeFall",n[n.Walking=2]="Walking";var C=e=>{let r=(0,c.useRef)(null),t=(0,c.useRef)(null);document.getElementById("fullscreen-btn");let[n,o]=(0,c.useState)("Free Float"),[s,u]=(0,c.useState)(!1),d=(0,c.useRef)(null),h=(0,c.useRef)(e.colorsConfig),m=(0,c.useRef)(null),p=(0,c.useRef)(null),f=(0,c.useRef)(null),g=(0,c.useRef)(null),b=(0,c.useRef)(null),S=(0,c.useRef)(null),D=(0,c.useRef)(null),C=(0,c.useRef)(null),j=(0,c.useRef)(null),A=(0,c.useRef)(0),V=(0,c.useRef)([]),N=(0,c.useRef)([]),_=(0,c.useRef)([]),I=(0,c.useRef)(null),q=(0,c.useRef)(null),K=(0,c.useRef)([]),W=()=>{S.current.fov=x.d$,S.current.aspect=x.lK,S.current.near=x.CC,S.current.far=x.wt,S.current.position.set(0,0,100)},T=(0,c.useRef)(0),Y=(0,c.useRef)(!1),G=(0,c.useRef)(!1),H=(0,c.useRef)(!1),Z=(0,c.useRef)(!1);(0,c.useRef)(!1);let X=(0,c.useRef)(new l.Pa4),B=(0,c.useRef)(new l.Pa4),J=()=>{var e,n,o;let a=null===(e=r.current)||void 0===e?void 0:e.clientWidth,c=null===(n=r.current)||void 0===n?void 0:n.clientHeight;null===(o=t.current)||void 0===o||o.setSize(a,c),S.current.aspect=a/c,S.current.updateProjectionMatrix()};(0,c.useEffect)(()=>{h.current=e.colorsConfig},[e.colorsConfig]),(0,c.useEffect)(()=>{let e=new l.CP7({antialias:!0});t.current=e,r.current.appendChild(t.current.domElement);let n=new l.xsS,o=new l.Mig(h.current.ambientLight);n.add(o),p.current=o;let a=new l.Ox3(h.current.directionalLight,100);a.position.set(50,50,50),n.add(a),f.current=a,m.current=n;let c=new l.cPb(x.d$,x.lK,x.CC,x.wt);c.position.set(0,0,100),S.current=c,J();let s=new i.z(c,t.current.domElement);s.enableDamping=!0,s.dampingFactor=.05,C.current=s;let u=new w(c,e.domElement);j.current=u,e.domElement.addEventListener("click",()=>{D.current instanceof w&&u.lock()}),u.domElement.ownerDocument.addEventListener("lock",()=>{console.log("Pointer locked")}),u.domElement.ownerDocument.addEventListener("unlock",()=>{console.log("Pointer unlocked")});let d=e=>{if(S.current&&D.current){if(D.current instanceof i.z){switch(console.log("Orbit lock movement"),e.key){case"w":let r=new l.Pa4(0,1,0);D.current.target.addScaledVector(r,10),S.current.position.addScaledVector(r,10);break;case"s":let t=new l.Pa4(0,-1,0);D.current.target.addScaledVector(t,10),S.current.position.addScaledVector(t,10);break;case"a":let n=new l.Pa4(-1,0,0);D.current.target.addScaledVector(n,10),S.current.position.addScaledVector(n,10);break;case"d":let o=new l.Pa4(1,0,0);D.current.target.addScaledVector(o,10),S.current.position.addScaledVector(o,10)}C.current.update()}else if(D.current instanceof w)switch(console.log("Pointer lock movement"),e.key){case"w":X.current.y=10;break;case"s":X.current.y=-10;break;case"a":X.current.x=-10;break;case"d":X.current.x=10;break;case"Space":S.current.position.z<=10&&(X.current.z=20)}}},g=e=>{if(D.current)switch(e.key){case"w":case"s":X.current.y=0;break;case"a":case"d":X.current.x=0;break;case"Space":X.current.z=0}};return window.addEventListener("resize",J),window.addEventListener("keydown",d),window.addEventListener("keyup",g),D.current=s,A.current=0,()=>{var n;window.removeEventListener("keydown",d),window.removeEventListener("keyup",g),null===(n=r.current)||void 0===n||n.removeChild(e.domElement),t.current.dispose()}},[]);let O=()=>{if(!h.current||!e.world||!m.current)return;let r=M(e.world,h.current);b.current=r,m.current.add(r)},U=()=>{if(!b.current||!e.world||!m.current||!N.current)return;if(e.world.temple){let[r,t]=k(e.world.temple,e.world.heightmap,b.current,12);N.current=N.current.concat(r),t.forEach(e=>{N.current=N.current.concat(e)})}if(e.world.docks){let r=E(e.world.docks,e.world.heightmap,b.current);N.current=N.current.concat(r)}let r=P(e.world,b.current);N.current=N.current.concat(r),N.current.forEach(e=>m.current.add(e))},$=()=>{e.world&&m.current&&_.current&&(_.current=[],e.world.templePath&&(_.current=_.current.concat(R(e.world.templePath,e.world.heightmap))),e.world.docksPath&&(_.current=_.current.concat(R(e.world.docksPath,e.world.heightmap))),_.current.forEach(e=>{m.current.add(e)}))},Q=()=>{if(!m.current||!e.world||!b.current)return;let[r,t,n]=v(e.world,b.current);V.current=[r,t,n],r&&m.current.add(r),t&&m.current.add(t),n&&m.current.add(n)},ee=()=>{m.current&&e.world&&(q.current=F(e.world.waterAccumulation,e.world.heightmap),m.current.add(q.current))},er=()=>{m.current&&e.world&&(K.current=L(e.world.waterAccumulation,e.world.heightmap),K.current.forEach(e=>m.current.add(e)))},et=()=>{m.current&&e.world&&b.current&&(I.current=z(e.world.flowDirections),m.current.add(I.current))};return(0,c.useEffect)(()=>{e.displayParams.drawTerrain?O():b.current&&m.current.remove(b.current)},[e.displayParams.drawTerrain]),(0,c.useEffect)(()=>{e.displayParams.drawStructures?U():N.current&&N.current.forEach(e=>m.current.remove(e))},[e.displayParams.drawStructures]),(0,c.useEffect)(()=>{e.displayParams.drawRoads?$():_.current&&_.current.forEach(e=>m.current.remove(e))},[e.displayParams.drawRoads]),(0,c.useEffect)(()=>{e.displayParams.showStructureFlares?Q():V.current&&V.current.forEach(e=>{e&&m.current.remove(e)})},[e.displayParams.showStructureFlares]),(0,c.useEffect)(()=>{e.displayParams.showFlowDirections?et():I.current&&m.current.remove(I.current)},[e.displayParams.showFlowDirections]),(0,c.useEffect)(()=>{e.displayParams.showWaterAccumulation?ee():q.current&&m.current.remove(q.current)},[e.displayParams.showWaterAccumulation]),(0,c.useEffect)(()=>{e.displayParams.showTrees?er():K.current&&K.current.forEach(e=>{e&&m.current.remove(e)})},[e.displayParams.showTrees]),(0,c.useEffect)(()=>{let e=new l.Mig(h.current.ambientLight);p.current=e},[e.colorsConfig.ambientLight]),(0,c.useEffect)(()=>{let e=new l.Ox3(h.current.directionalLight);f.current=e},[e.colorsConfig.directionalLight]),(0,c.useEffect)(()=>{let n;if(m.current)for(;m.current.children.length>0;)m.current.remove(m.current.children[0]);if(A.current=0,W(),C.current.enabled=!0,!r.current||!e.world||!t.current)return;g.current=new l.SUY,N.current=[],_.current=[],m.current&&(e.displayParams.drawTerrain&&O(),e.displayParams.drawStructures&&U(),e.displayParams.drawRoads&&$(),e.displayParams.showStructureFlares&&Q(),e.displayParams.showFlowDirections&&et(),e.displayParams.showWaterAccumulation&&ee(),e.displayParams.showTrees&&er(),p.current&&m.current.add(p.current),f.current&&m.current.add(f.current));let a=()=>{n=requestAnimationFrame(a);let e=g.current.getDelta();if(1===A.current){o("Free Fall"),T.current+=9.81*e,S.current.position.z-=T.current*e;let r=new l.Pa4(0,0,-1),t=new l.iMs;t.set(S.current.position,r);let n=t.intersectObject(b.current);n.length>0&&n[0].distance<=T.current*e&&(S.current.position.z=5,S.current.lookAt(new l.Pa4(1,0,0)),S.current.setRotationFromEuler(new l.USm(0,0,0,"ZYX")),A.current=2,D.current=j.current,T.current=0)}else if(2===A.current){o("Fly-Hack");let r=X.current;B.current,r.x-=10*r.x*e,r.y-=10*r.y*e,Y.current&&(r.y+=10*e),G.current&&(r.y-=10*e),H.current&&(r.x-=10*e),Z.current&&(r.x+=10*e),D.current.moveRight(r.x*e),D.current.moveForward(-1*r.y*e)}else 0===A.current&&(o("Free Float"),C.current.update());t.current.render(m.current,S.current)};return a(),()=>cancelAnimationFrame(n)},[e.world]),(0,a.jsx)("div",{ref:d,id:"three-container",tabIndex:0,className:"p-4 flex-1",children:(0,a.jsxs)("div",{className:"h-full justify-center",children:[(0,a.jsx)("div",{id:"fullscreen-button-container",className:"relative",children:(0,a.jsx)(y.z,{id:"fullscreen-btn",onClick:()=>{},className:"absolute top-1 right-2 z-10 p-4 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:"『』"})}),(0,a.jsx)("div",{id:"cameramode-label-container",className:"relative",children:(0,a.jsx)("div",{className:"flex p-4 absolute top-1 left-1 z-10",children:(0,a.jsxs)("span",{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:["Camera Mode: ",n]})})}),(0,a.jsx)("div",{ref:r,className:"h-full w-full bg-primary"}),(0,a.jsx)("div",{id:"buttons-container",className:"relative",children:(0,a.jsxs)("div",{className:"flex p-4 absolute bottom-1 left-1 z-10",children:[(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{S.current&&D.current&&(W(),A.current=0,S.current.updateProjectionMatrix(),C.current.reset(),C.current.enabled=!0,D.current=C.current)},children:"\uD83D\uDDFA️"}),(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{if(!S.current||!D.current||!e.world||!b.current)return;let r=new l.Pa4(e.world.townSquare.x-b.current.geometry.parameters.width/2,e.world.heightmap.length-e.world.townSquare.y-b.current.geometry.parameters.height/2,10);A.current=0,D.current=C.current,S.current.position.set(r.x,r.y,50),C.current.target.copy(r),C.current.update(),C.current.enabled=!0},children:"\uD83C\uDFD8️"}),(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{C.current.enabled=!1,A.current=1},children:"\uD83E\uDE82"}),(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{C.current.enabled=!1,A.current=2,D.current=j.current},children:"\uD83D\uDEE9️"})]})})]})})}}}]);