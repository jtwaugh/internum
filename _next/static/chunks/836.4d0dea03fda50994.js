"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[836],{6836:function(e,r,t){t.r(r),t.d(r,{default:function(){return V}});var n,o,c=t(7437),a=t(2265),i=t(7776),u=t(8938);let l=new i.USm(0,0,0,"ZYX"),s=new i.Pa4,d={type:"change"},h={type:"lock"},m={type:"unlock"};class w{connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}moveForward(e){this.isLocked&&(s.setFromMatrixColumn(this.camera.matrix,2),this.camera.position.addScaledVector(s,e))}moveRight(e){this.isLocked&&(s.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(s,e))}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}constructor(e,r=document.body){this.camera=e,this.domElement=r,this.isLocked=!1,this.pointerSpeed=1,this._onMouseMove=p.bind(this),this._onPointerlockChange=f.bind(this),this._onPointerlockError=g.bind(this),this.connect()}}function p(e){if(!this.isLocked)return;let r=e.movementX||e.mozMovementX||e.webkitMovementX||0,t=e.movementY||e.mozMovementY||e.webkitMovementY||0;l.setFromQuaternion(this.camera.quaternion),l.z-=.002*r*this.pointerSpeed,l.x-=.002*t*this.pointerSpeed,this.camera.quaternion.setFromEuler(l),this.camera.dispatchEvent(d)}function f(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.isLocked=!0,this.camera.dispatchEvent(h)):(this.isLocked=!1,this.camera.dispatchEvent(m))}function g(){console.error("FPSControls: Unable to use Pointer Lock API")}var y=t(9733),x=t(1648);let v=(e,r)=>{let t=new i.Pa4(0,0,-1),n=new i.iMs;return n.set(e,t),n.intersectObject(r)},b=(e,r,t)=>{let n=e.distanceTo(r),o=new i.fHI(.5,.5,n,32),c=new i.vBJ({color:t}),a=new i.Kj0(o,c),u=new i.Pa4().addVectors(e,r).multiplyScalar(.5);a.position.copy(u);let l=new i.Pa4().subVectors(r,e).normalize(),s=new i.Pa4(0,1,0).cross(l).normalize(),d=Math.acos(new i.Pa4(0,1,0).dot(l));return a.quaternion.setFromAxisAngle(s,d),a},k=(e,r)=>{let t=r.geometry,n=new i.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.heightmap.length-e.townSquare.y]*x.Vl),o=null;if(e.docks){let r=new i.Pa4(e.docks.x-t.parameters.width/2,e.heightmap.length-e.docks.y-t.parameters.height/2,e.heightmap[e.docks.x][e.heightmap.length-e.docks.y]*x.Vl),n=new i.Pa4(r.x,r.y,r.z+10);o=b(r,n,65535)}let c=null;if(e.temple){let r=new i.Pa4(e.temple.x-t.parameters.width/2,e.heightmap.length-e.temple.y-t.parameters.height/2,e.heightmap[e.temple.x][e.heightmap.length-e.temple.y]*x.Vl),n=new i.Pa4(r.x,r.y,r.z+10);c=b(r,n,16776960)}let a=new i.Pa4(n.x,n.y,n.z+10);return[b(n,a,16711935),o,c]},E=(e,r,t,n)=>{let o=t.geometry,c=new i.Pa4(e.x-o.parameters.width/2,r.length-e.y-o.parameters.height/2,r[e.x][e.y]*x.Vl),a=new i.Wid({color:16773358,roughness:.5,metalness:.1}),u=new i.fHI(15/n,13/n,2/n,32),l=new i.Kj0(u,a);l.position.set(c.x,c.y,c.z),l.rotation.x=-Math.PI/2;let s=new i.fHI(.5/n,.5/n,10/n,32),d=12/n,h=[];for(let e=0;e<12;e++){let r=e/12*2*Math.PI,t=d*Math.cos(r)+c.x,o=d*Math.sin(r)+c.y,u=new i.Kj0(s,a);u.position.set(t,o,c.z+5/n),u.rotation.x=-Math.PI/2,h=h.concat(u)}return[l,h]},P=(e,r)=>{let t=r.geometry,n=new i.Wid({color:16773358,roughness:.5,metalness:.1}),o=new i.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.townSquare.y]*x.Vl),c=new i.DvJ(1.2,1.2,.1),a=new i.Kj0(c,n);return a.position.set(o.x,o.y,o.z),a},z=(e,r,t)=>{let n=t.geometry,o=new i.Wid({color:16773358,roughness:.5,metalness:.1}),c=new i.Pa4(e.x-n.parameters.width/2,r.length-e.y-n.parameters.height/2,r[e.x][e.y]*x.Vl),a=new i.DvJ(1.2,1.2,.1),u=new i.Kj0(a,o);return u.position.set(c.x,c.y,c.z),u},S=(e,r,t)=>{t=Math.min(Math.max(t,0),1);let n=parseInt(e.substring(1),16),o=parseInt(r.substring(1),16),c=n>>16&255,a=n>>8&255,i=255&n,u=Math.round(c+t*((o>>16&255)-c)),l=Math.round(a+t*((o>>8&255)-a)),s=Math.round(i+t*((255&o)-i));return"#".concat((u<<16|l<<8|s).toString(16).padStart(6,"0"))},M=(e,r)=>{let t=e.heightmap.length,n=new i._12(t,t,t-1,t-1),o=[];for(let c=0;c<n.attributes.position.array.length;c+=3){let a;let u=Math.floor(c/3%t),l=Math.floor(c/3/t);n.attributes.position.setZ(c/3,10*e.heightmap[u][l]),a=new i.Ilk(e.heightmap[u][l]<.2?S(r.terrainGradient[0],r.terrainGradient[1],5*e.heightmap[u][l]):e.heightmap[u][l]<.3?S(r.terrainGradient[1],r.terrainGradient[2],e.heightmap[u][l]*(1/.3)):S(r.terrainGradient[2],r.terrainGradient[3],(e.heightmap[u][l]-.3)*(1/.7))),o.push(a.r,a.g,a.b)}n.setAttribute("color",new i.a$l(o,3)),n.computeVertexNormals();let c=new i.YBo({vertexColors:!0,flatShading:!0});return new i.Kj0(n,c)},L=(e,r,t)=>{let n=new i._12(r,r,r-1,r-1),o=[];for(let r=0;r<n.attributes.position.array.length;r+=3){n.attributes.position.setZ(r/3,10*e);let c=new i.Ilk(t.waterColor);o.push(c.r,c.g,c.b)}n.setAttribute("color",new i.a$l(o,3)),n.computeVertexNormals();let c=new i.YBo({vertexColors:!0,flatShading:!0});return new i.Kj0(n,c)},R=(e,r)=>{let t=e.length,n=new i.Ilk(2237149),o=new i.ZAu,c=0;for(let r=0;r<t;r++)for(let n=0;n<t;n++)null!==e[r][n]&&e[r][n]>c&&(c=e[r][n]);for(let a=0;a<t;a++)for(let u=0;u<t;u++){if(null===e[a][u])continue;let l=e[a][u]/c;if(l<.05)continue;let s=new i.zf8(l,4),d=new i.vBJ({color:n}),h=new i.Kj0(s,d);h.position.set(a-t/2,t-u-t/2,10*r[a][u]+.5),o.add(h)}return o},F=e=>{let r=e.length,t=new i.ZAu;for(let n=0;n<r;n++)for(let o=0;o<r;o++){let c=e[n][o];if(null!==c){let e=x.nK[c],a=new i.Pa4(e[0],-e[1],0).normalize(),u=new i.tGC(a,new i.Pa4(n-r/2,r-o-r/2,12),1,11184895,.2,.2);t.add(u)}}return t},C=(e,r)=>{let t=new i.u9r,n=r.length,o=new Float32Array(3*e.length);e.forEach((e,t)=>{o[3*t]=e.x-n/2,o[3*t+1]=n-e.y-n/2,o[3*t+2]=10*r[e.x][e.y]+.2}),t.setAttribute("position",new i.TlE(o,3));let c=new i.nls({color:16777215,linewidth:2});return new i.x12(t,c)},D=(e,r,t)=>{let n=new i.ZAu,o=new i.fHI(.02+.05*t,.03+.05*t,.5,6),c=new i.Wid({color:9127187}),a=new i.Kj0(o,c);a.position.set(r.x,r.y,r.z),a.rotation.x=-Math.PI/2,n.add(a);let u=new i.Wid({color:2263842}),l=[new i.b_z(.25+.25*t,.15+.15*t,5),new i.b_z(.2+.2*t,.18+.18*t,5),new i.b_z(.15+.15*t,.1+.1*t,5)],s=[.1+.4*t,.2+.4*t,.3+.4*t];return l.forEach((e,t)=>{let o=new i.Kj0(e,u);o.rotation.x=Math.PI/2,o.position.set(r.x,r.y,r.z+s[t]),n.add(o)}),n},j=(e,r,t,n)=>{let o=r.length,c=[],a=0;for(let r=0;r<o;r++)for(let t=0;t<o;t++)null!==e[r][t]&&e[r][t]>a&&(a=e[r][t]);for(let u=0;u<o;u++)for(let l=0;l<o;l++){if(r[u][l]<t)continue;let o=Math.log(e[u][l]/a*(a-1)+1)/Math.log(a);if(o>.3){let e=Math.random()+u-r.length/2,a=Math.random()+(r.length-l)-r.length/2,s=v(new i.Pa4(e,a,9001),n);if(1!==s.length)continue;let d=s[0].point.z;if(d<10*t)continue;c=c.concat(D({x:u,y:l},new i.Pa4(e,a,d),o))}}return c};(n=o||(o={}))[n.FreeFloat=0]="FreeFloat",n[n.Walking=1]="Walking",n[n.FlyHack=2]="FlyHack";var V=e=>{let r=(0,a.useRef)(null),t=(0,a.useRef)(null);document.getElementById("fullscreen-btn");let[n,o]=(0,a.useState)("Free Float"),[l,s]=(0,a.useState)(!1),d=(0,a.useRef)(null),h=(0,a.useRef)(e.colorsConfig),m=(0,a.useRef)(null),p=(0,a.useRef)(null),f=(0,a.useRef)(null),g=(0,a.useRef)(null),b=(0,a.useRef)(null),S=(0,a.useRef)(null),D=(0,a.useRef)(null),V=(0,a.useRef)(null),A=(0,a.useRef)(null),N=(0,a.useRef)(null),_=(0,a.useRef)(0),I=(0,a.useRef)([]),q=(0,a.useRef)([]),W=(0,a.useRef)([]),K=(0,a.useRef)(null),G=(0,a.useRef)(null),H=(0,a.useRef)([]),T=()=>{D.current.fov=x.d$,D.current.aspect=x.lK,D.current.near=x.CC,D.current.far=x.wt,D.current.position.set(0,0,100)},Y=(0,a.useRef)(!1),Z=(0,a.useRef)(!1),B=(0,a.useRef)(!1),O=(0,a.useRef)(!1),J=(0,a.useRef)(!1),X=(0,a.useRef)(new i.Pa4),$=(0,a.useRef)(new i.Pa4),U=()=>{var e,n,o;let c=null===(e=r.current)||void 0===e?void 0:e.clientWidth,a=null===(n=r.current)||void 0===n?void 0:n.clientHeight;null===(o=t.current)||void 0===o||o.setSize(c,a),D.current.aspect=c/a,D.current.updateProjectionMatrix()};(0,a.useEffect)(()=>{h.current=e.colorsConfig},[e.colorsConfig]),(0,a.useEffect)(()=>{let e=new i.CP7({antialias:!0});t.current=e,r.current.appendChild(t.current.domElement);let n=new i.xsS,o=new i.Mig(h.current.ambientLight);n.add(o),p.current=o;let c=new i.Ox3(h.current.directionalLight,100);c.position.set(50,50,50),n.add(c),f.current=c,m.current=n;let a=new i.cPb(x.d$,x.lK,x.CC,x.wt);a.position.set(0,0,100),D.current=a,U();let l=new u.z(a,t.current.domElement);l.enableDamping=!0,l.dampingFactor=.05,A.current=l;let s=new w(a,e.domElement);N.current=s,s.domElement.ownerDocument.addEventListener("lock",()=>{console.log("Pointer locked")}),s.domElement.ownerDocument.addEventListener("unlock",()=>{console.log("Pointer unlocked")});let d=e=>{if(D.current&&V.current){if(V.current instanceof u.z){switch(console.log("Orbit lock movement"),e.key){case"w":let r=new i.Pa4(0,1,0);V.current.target.addScaledVector(r,10),D.current.position.addScaledVector(r,10);break;case"s":let t=new i.Pa4(0,-1,0);V.current.target.addScaledVector(t,10),D.current.position.addScaledVector(t,10);break;case"a":let n=new i.Pa4(-1,0,0);V.current.target.addScaledVector(n,10),D.current.position.addScaledVector(n,10);break;case"d":let o=new i.Pa4(1,0,0);V.current.target.addScaledVector(o,10),D.current.position.addScaledVector(o,10)}A.current.update()}else if(V.current instanceof w)switch(console.log(e),e.key){case"w":Y.current=!0,Z.current=!1;break;case"s":Z.current=!0,Y.current=!1;break;case"a":B.current=!0,O.current=!1;break;case"d":O.current=!0,B.current=!1;break;case" ":J.current&&(X.current.z=20,J.current=!1);default:Y.current=!1,Z.current=!1,B.current=!1,O.current=!1}}},g=e=>{if(V.current)switch(e.key){case"w":Y.current=!1;break;case"s":Z.current=!1;break;case"a":B.current=!1;break;case"d":O.current=!1}};return window.addEventListener("resize",U),window.addEventListener("keydown",d),window.addEventListener("keyup",g),V.current=l,_.current=0,()=>{var n;window.removeEventListener("keydown",d),window.removeEventListener("keyup",g),null===(n=r.current)||void 0===n||n.removeChild(e.domElement),t.current.dispose()}},[]);let Q=()=>{if(!h.current||!e.world||!m.current)return;let r=M(e.world,h.current);b.current=r,m.current.add(r)},ee=()=>{if(!h.current||!e.world||!m.current)return;let r=L(e.world.waterLevel,e.world.heightmap.length,h.current);S.current=r,m.current.add(r)},er=()=>{if(!b.current||!e.world||!m.current||!q.current)return;if(e.world.temple){let[r,t]=E(e.world.temple,e.world.heightmap,b.current,12);q.current=q.current.concat(r),t.forEach(e=>{q.current=q.current.concat(e)})}if(e.world.docks){let r=z(e.world.docks,e.world.heightmap,b.current);q.current=q.current.concat(r)}let r=P(e.world,b.current);q.current=q.current.concat(r),q.current.forEach(e=>m.current.add(e))},et=()=>{e.world&&m.current&&W.current&&(W.current=[],e.world.templePath&&(W.current=W.current.concat(C(e.world.templePath,e.world.heightmap))),e.world.docksPath&&(W.current=W.current.concat(C(e.world.docksPath,e.world.heightmap))),W.current.forEach(e=>{m.current.add(e)}))},en=()=>{if(!m.current||!e.world||!b.current)return;let[r,t,n]=k(e.world,b.current);I.current=[r,t,n],r&&m.current.add(r),t&&m.current.add(t),n&&m.current.add(n)},eo=()=>{m.current&&e.world&&(G.current=R(e.world.waterAccumulation,e.world.heightmap),m.current.add(G.current))},ec=()=>{m.current&&e.world&&b.current&&(H.current=j(e.world.waterAccumulation,e.world.heightmap,e.world.waterLevel,b.current),H.current.forEach(e=>m.current.add(e)))},ea=()=>{m.current&&e.world&&b.current&&(K.current=F(e.world.flowDirections),m.current.add(K.current))};return(0,a.useEffect)(()=>{e.displayParams.drawTerrain?Q():b.current&&m.current.remove(b.current)},[e.displayParams.drawTerrain]),(0,a.useEffect)(()=>{e.displayParams.drawWater?Q():S.current&&m.current.remove(S.current)},[e.displayParams.drawWater]),(0,a.useEffect)(()=>{e.displayParams.drawStructures?er():q.current&&q.current.forEach(e=>m.current.remove(e))},[e.displayParams.drawStructures]),(0,a.useEffect)(()=>{e.displayParams.drawRoads?et():W.current&&W.current.forEach(e=>m.current.remove(e))},[e.displayParams.drawRoads]),(0,a.useEffect)(()=>{e.displayParams.showStructureFlares?en():I.current&&I.current.forEach(e=>{e&&m.current.remove(e)})},[e.displayParams.showStructureFlares]),(0,a.useEffect)(()=>{e.displayParams.showFlowDirections?ea():K.current&&m.current.remove(K.current)},[e.displayParams.showFlowDirections]),(0,a.useEffect)(()=>{e.displayParams.showWaterAccumulation?eo():G.current&&m.current.remove(G.current)},[e.displayParams.showWaterAccumulation]),(0,a.useEffect)(()=>{e.displayParams.showTrees?ec():H.current&&H.current.forEach(e=>{e&&m.current.remove(e)})},[e.displayParams.showTrees]),(0,a.useEffect)(()=>{let e=new i.Mig(h.current.ambientLight);p.current=e},[e.colorsConfig.ambientLight]),(0,a.useEffect)(()=>{let e=new i.Ox3(h.current.directionalLight);f.current=e},[e.colorsConfig.directionalLight]),(0,a.useEffect)(()=>{let n;if(m.current)for(;m.current.children.length>0;)m.current.remove(m.current.children[0]);if(_.current=0,T(),A.current.enabled=!0,!r.current||!e.world||!t.current)return;g.current=new i.SUY,q.current=[],W.current=[],m.current&&(e.displayParams.drawTerrain&&Q(),e.displayParams.drawWater&&ee(),e.displayParams.drawStructures&&er(),e.displayParams.drawRoads&&et(),e.displayParams.showStructureFlares&&en(),e.displayParams.showFlowDirections&&ea(),e.displayParams.showWaterAccumulation&&eo(),e.displayParams.showTrees&&ec(),p.current&&m.current.add(p.current),f.current&&m.current.add(f.current));let c=()=>{n=requestAnimationFrame(c);let e=g.current.getDelta();if(1===_.current){o("Gravity On");let r=v(new i.Pa4(D.current.position.x,D.current.position.y,999),b.current),t=X.current;r.length>0&&(r[0].point.z>D.current.position.z+X.current.z*e-.5?(D.current.position.z=r[0].point.z+.5,t.z<1e-4?t.z=0:D.current.position.z+=t.z*e,.01>Math.abs(t.x)?t.x=0:t.x-=10*t.x*e,.01>Math.abs(t.y)?t.y=0:t.y-=10*t.y*e,Y.current&&(t.y+=10*e),Z.current&&(t.y-=10*e),B.current&&(t.x-=10*e),O.current&&(t.x+=10*e),J.current=!0):(D.current.position.z+=t.z*e,t.z-=9.81*e)),V.current.moveRight(t.x*e),V.current.moveForward(-1*t.y*e)}else if(2===_.current){o("Fly-Hack");let r=X.current;$.current,r.x-=10*r.x*e,r.y-=10*r.y*e,Y.current&&(r.y+=10*e),Z.current&&(r.y-=10*e),B.current&&(r.x-=10*e),O.current&&(r.x+=10*e),V.current.moveRight(r.x*e),V.current.moveForward(-1*r.y*e)}else 0===_.current&&(o("Free Float"),A.current.update());t.current.render(m.current,D.current)};return c(),()=>cancelAnimationFrame(n)},[e.world]),(0,c.jsx)("div",{ref:d,id:"three-container",tabIndex:0,className:"p-4 flex-1",children:(0,c.jsxs)("div",{className:"h-full justify-center",children:[(0,c.jsx)("div",{id:"fullscreen-button-container",className:"relative",children:(0,c.jsx)(y.z,{id:"fullscreen-btn",onClick:()=>{},className:"absolute top-1 right-2 z-10 p-4 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:"『』"})}),(0,c.jsx)("div",{id:"cameramode-label-container",className:"relative",children:(0,c.jsx)("div",{className:"flex p-4 absolute top-1 left-1 z-10",children:(0,c.jsxs)("span",{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:["Camera Mode: ",n]})})}),(0,c.jsx)("div",{ref:r,className:"h-full w-full bg-primary"}),(0,c.jsx)("div",{id:"buttons-container",className:"relative",children:(0,c.jsxs)("div",{className:"flex p-4 absolute bottom-1 left-1 z-10",children:[(0,c.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{D.current&&V.current&&(T(),_.current=0,D.current.updateProjectionMatrix(),A.current.reset(),A.current.enabled=!0,V.current=A.current,t.current.domElement.removeEventListener("click",()=>{V.current instanceof w&&N.current.lock()}))},children:"\uD83D\uDDFA️"}),(0,c.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{if(!D.current||!V.current||!e.world||!b.current)return;let r=new i.Pa4(e.world.townSquare.x-b.current.geometry.parameters.width/2,e.world.heightmap.length-e.world.townSquare.y-b.current.geometry.parameters.height/2,10);_.current=0,V.current=A.current,D.current.position.set(r.x,r.y,50),A.current.target.copy(r),A.current.update(),N.current.unlock(),A.current.enabled=!0,t.current.domElement.removeEventListener("click",()=>{V.current instanceof w&&N.current.lock()})},children:"\uD83C\uDFD8️"}),(0,c.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{A.current.enabled=!1,V.current=N.current,t.current.domElement.addEventListener("click",()=>{V.current instanceof w&&N.current.lock()}),_.current=1},children:"\uD83E\uDE82"}),(0,c.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{A.current.enabled=!1,t.current.domElement.addEventListener("click",()=>{V.current instanceof w&&N.current.lock()}),_.current=2,V.current=N.current},children:"\uD83D\uDEE9️"})]})})]})})}}}]);