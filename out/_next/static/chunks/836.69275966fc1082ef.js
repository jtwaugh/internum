"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[836],{6836:function(e,r,t){t.r(r),t.d(r,{default:function(){return V}});var n,o,a=t(7437),c=t(2265),l=t(7776),i=t(8938);let u=new l.USm(0,0,0,"ZYX"),s=new l.Pa4,d={type:"change"},h={type:"lock"},m={type:"unlock"};class w{connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}moveForward(e){this.isLocked&&(s.setFromMatrixColumn(this.camera.matrix,2),this.camera.position.addScaledVector(s,e))}moveRight(e){this.isLocked&&(s.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(s,e))}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}constructor(e,r=document.body){this.camera=e,this.domElement=r,this.isLocked=!1,this.pointerSpeed=1,this._onMouseMove=p.bind(this),this._onPointerlockChange=f.bind(this),this._onPointerlockError=g.bind(this),this.connect()}}function p(e){if(!this.isLocked)return;let r=e.movementX||e.mozMovementX||e.webkitMovementX||0,t=e.movementY||e.mozMovementY||e.webkitMovementY||0;u.setFromQuaternion(this.camera.quaternion),u.z-=.002*r*this.pointerSpeed,u.x-=.002*t*this.pointerSpeed,this.camera.quaternion.setFromEuler(u),this.camera.dispatchEvent(d)}function f(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.isLocked=!0,this.camera.dispatchEvent(h)):(this.isLocked=!1,this.camera.dispatchEvent(m))}function g(){console.error("FPSControls: Unable to use Pointer Lock API")}var y=t(9733),x=t(1648);let v=(e,r)=>{let t=new l.Pa4(0,0,-1),n=new l.iMs;return n.set(e,t),n.intersectObject(r)},b=(e,r,t)=>{let n=e.distanceTo(r),o=new l.fHI(.5,.5,n,32),a=new l.vBJ({color:t}),c=new l.Kj0(o,a),i=new l.Pa4().addVectors(e,r).multiplyScalar(.5);c.position.copy(i);let u=new l.Pa4().subVectors(r,e).normalize(),s=new l.Pa4(0,1,0).cross(u).normalize(),d=Math.acos(new l.Pa4(0,1,0).dot(u));return c.quaternion.setFromAxisAngle(s,d),c},k=(e,r)=>{let t=r.geometry,n=new l.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.heightmap.length-e.townSquare.y]*x.Vl),o=null;if(e.docks){let r=new l.Pa4(e.docks.x-t.parameters.width/2,e.heightmap.length-e.docks.y-t.parameters.height/2,e.heightmap[e.docks.x][e.heightmap.length-e.docks.y]*x.Vl),n=new l.Pa4(r.x,r.y,r.z+10);o=b(r,n,65535)}let a=null;if(e.temple){let r=new l.Pa4(e.temple.x-t.parameters.width/2,e.heightmap.length-e.temple.y-t.parameters.height/2,e.heightmap[e.temple.x][e.heightmap.length-e.temple.y]*x.Vl),n=new l.Pa4(r.x,r.y,r.z+10);a=b(r,n,16776960)}let c=new l.Pa4(n.x,n.y,n.z+10);return[b(n,c,16711935),o,a]},P=(e,r,t,n)=>{let o=t.geometry,a=new l.Pa4(e.x-o.parameters.width/2,r.length-e.y-o.parameters.height/2,r[e.x][e.y]*x.Vl),c=new l.Wid({color:16773358,roughness:.5,metalness:.1}),i=new l.fHI(15/n,13/n,2/n,32),u=new l.Kj0(i,c);u.position.set(a.x,a.y,a.z),u.rotation.x=-Math.PI/2;let s=new l.fHI(.5/n,.5/n,10/n,32),d=12/n,h=[];for(let e=0;e<12;e++){let r=e/12*2*Math.PI,t=d*Math.cos(r)+a.x,o=d*Math.sin(r)+a.y,i=new l.Kj0(s,c);i.position.set(t,o,a.z+5/n),i.rotation.x=-Math.PI/2,h=h.concat(i)}return[u,h]},E=(e,r)=>{let t=r.geometry,n=new l.Wid({color:16773358,roughness:.5,metalness:.1}),o=new l.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.townSquare.y]*x.Vl),a=new l.DvJ(1.2,1.2,.1),c=new l.Kj0(a,n);return c.position.set(o.x,o.y,o.z),c},S=(e,r,t)=>{let n=t.geometry,o=new l.Wid({color:16773358,roughness:.5,metalness:.1}),a=new l.Pa4(e.x-n.parameters.width/2,r.length-e.y-n.parameters.height/2,r[e.x][e.y]*x.Vl),c=new l.DvJ(1.2,1.2,.1),i=new l.Kj0(c,o);return i.position.set(a.x,a.y,a.z),i},z=(e,r,t)=>{t=Math.min(Math.max(t,0),1);let n=parseInt(e.substring(1),16),o=parseInt(r.substring(1),16),a=n>>16&255,c=n>>8&255,l=255&n,i=Math.round(a+t*((o>>16&255)-a)),u=Math.round(c+t*((o>>8&255)-c)),s=Math.round(l+t*((255&o)-l));return"#".concat((i<<16|u<<8|s).toString(16).padStart(6,"0"))},M=(e,r)=>{let t=e.heightmap.length,n=new l._12(t,t,t-1,t-1),o=[];for(let a=0;a<n.attributes.position.array.length;a+=3){let c;let i=Math.floor(a/3%t),u=Math.floor(a/3/t);n.attributes.position.setZ(a/3,10*e.heightmap[i][u]),c=new l.Ilk(e.heightmap[i][u]<.2?z(r.terrainGradient[0],r.terrainGradient[1],5*e.heightmap[i][u]):e.heightmap[i][u]<.3?z(r.terrainGradient[1],r.terrainGradient[2],e.heightmap[i][u]*(1/.3)):z(r.terrainGradient[2],r.terrainGradient[3],(e.heightmap[i][u]-.3)*(1/.7))),o.push(c.r,c.g,c.b)}n.setAttribute("color",new l.a$l(o,3)),n.computeVertexNormals();let a=new l.YBo({vertexColors:!0,flatShading:!0});return new l.Kj0(n,a)},F=(e,r,t)=>{let n=new l._12(r,r,r-1,r-1),o=[];for(let r=0;r<n.attributes.position.array.length;r+=3){n.attributes.position.setZ(r/3,10*e);let a=new l.Ilk(t.waterColor);o.push(a.r,a.g,a.b)}n.setAttribute("color",new l.a$l(o,3)),n.computeVertexNormals();let a=new l.YBo({vertexColors:!0,flatShading:!0});return new l.Kj0(n,a)},R=(e,r)=>{let t=e.length,n=new l.Ilk(2237149),o=new l.ZAu,a=0;for(let r=0;r<t;r++)for(let n=0;n<t;n++)null!==e[r][n]&&e[r][n]>a&&(a=e[r][n]);for(let c=0;c<t;c++)for(let i=0;i<t;i++){if(null===e[c][i])continue;let u=e[c][i]/a;if(u<.05)continue;let s=new l.zf8(u,4),d=new l.vBJ({color:n}),h=new l.Kj0(s,d);h.position.set(c-t/2,t-i-t/2,10*r[c][i]+.5),o.add(h)}return o},L=e=>{let r=e.length,t=new l.ZAu;for(let n=0;n<r;n++)for(let o=0;o<r;o++){let a=e[n][o];if(null!==a){let e=x.nK[a],c=new l.Pa4(e[0],-e[1],0).normalize(),i=new l.tGC(c,new l.Pa4(n-r/2,r-o-r/2,12),1,11184895,.2,.2);t.add(i)}}return t},C=(e,r)=>{let t=new l.u9r,n=r.length,o=new Float32Array(3*e.length);e.forEach((e,t)=>{o[3*t]=e.x-n/2,o[3*t+1]=n-e.y-n/2,o[3*t+2]=10*r[e.x][e.y]+.2}),t.setAttribute("position",new l.TlE(o,3));let a=new l.nls({color:16777215,linewidth:2});return new l.x12(t,a)},D=(e,r,t)=>{let n=new l.ZAu,o=new l.fHI(.02+.05*t,.03+.05*t,.5,6),a=new l.Wid({color:9127187}),c=new l.Kj0(o,a);c.position.set(r.x,r.y,r.z),c.rotation.x=-Math.PI/2,n.add(c);let i=new l.Wid({color:2263842}),u=[new l.b_z(.25+.25*t,.15+.15*t,5),new l.b_z(.2+.2*t,.18+.18*t,5),new l.b_z(.15+.15*t,.1+.1*t,5)],s=[.1+.4*t,.2+.4*t,.3+.4*t];return u.forEach((e,t)=>{let o=new l.Kj0(e,i);o.rotation.x=Math.PI/2,o.position.set(r.x,r.y,r.z+s[t]),n.add(o)}),n},j=(e,r,t,n)=>{let o=r.length,a=[],c=0;for(let r=0;r<o;r++)for(let t=0;t<o;t++)null!==e[r][t]&&e[r][t]>c&&(c=e[r][t]);for(let i=0;i<o;i++)for(let u=0;u<o;u++){if(r[i][u]<t)continue;let o=Math.log(e[i][u]/c*(c-1)+1)/Math.log(c);if(o>.3){let e=Math.random()+i-r.length/2,c=Math.random()+(r.length-u)-r.length/2,s=v(new l.Pa4(e,c,9001),n);if(1!==s.length)continue;let d=s[0].point.z;if(d<10*t)continue;a=a.concat(D({x:i,y:u},new l.Pa4(e,c,d),o))}}return a};(n=o||(o={}))[n.FreeFloat=0]="FreeFloat",n[n.FreeFall=1]="FreeFall",n[n.Walking=2]="Walking";var V=e=>{let r=(0,c.useRef)(null),t=(0,c.useRef)(null);document.getElementById("fullscreen-btn");let[n,o]=(0,c.useState)("Free Float"),[u,s]=(0,c.useState)(!1),d=(0,c.useRef)(null),h=(0,c.useRef)(e.colorsConfig),m=(0,c.useRef)(null),p=(0,c.useRef)(null),f=(0,c.useRef)(null),g=(0,c.useRef)(null),b=(0,c.useRef)(null),z=(0,c.useRef)(null),D=(0,c.useRef)(null),V=(0,c.useRef)(null),A=(0,c.useRef)(null),N=(0,c.useRef)(null),_=(0,c.useRef)(0),I=(0,c.useRef)([]),q=(0,c.useRef)([]),W=(0,c.useRef)([]),K=(0,c.useRef)(null),T=(0,c.useRef)(null),Y=(0,c.useRef)([]),G=()=>{D.current.fov=x.d$,D.current.aspect=x.lK,D.current.near=x.CC,D.current.far=x.wt,D.current.position.set(0,0,100)},Z=(0,c.useRef)(0),H=(0,c.useRef)(!1),B=(0,c.useRef)(!1),X=(0,c.useRef)(!1),J=(0,c.useRef)(!1);(0,c.useRef)(!1);let O=(0,c.useRef)(new l.Pa4),U=(0,c.useRef)(new l.Pa4),$=()=>{var e,n,o;let a=null===(e=r.current)||void 0===e?void 0:e.clientWidth,c=null===(n=r.current)||void 0===n?void 0:n.clientHeight;null===(o=t.current)||void 0===o||o.setSize(a,c),D.current.aspect=a/c,D.current.updateProjectionMatrix()};(0,c.useEffect)(()=>{h.current=e.colorsConfig},[e.colorsConfig]),(0,c.useEffect)(()=>{let e=new l.CP7({antialias:!0});t.current=e,r.current.appendChild(t.current.domElement);let n=new l.xsS,o=new l.Mig(h.current.ambientLight);n.add(o),p.current=o;let a=new l.Ox3(h.current.directionalLight,100);a.position.set(50,50,50),n.add(a),f.current=a,m.current=n;let c=new l.cPb(x.d$,x.lK,x.CC,x.wt);c.position.set(0,0,100),D.current=c,$();let u=new i.z(c,t.current.domElement);u.enableDamping=!0,u.dampingFactor=.05,A.current=u;let s=new w(c,e.domElement);N.current=s,s.domElement.ownerDocument.addEventListener("lock",()=>{console.log("Pointer locked")}),s.domElement.ownerDocument.addEventListener("unlock",()=>{console.log("Pointer unlocked")});let d=e=>{if(D.current&&V.current){if(V.current instanceof i.z){switch(console.log("Orbit lock movement"),e.key){case"w":let r=new l.Pa4(0,1,0);V.current.target.addScaledVector(r,10),D.current.position.addScaledVector(r,10);break;case"s":let t=new l.Pa4(0,-1,0);V.current.target.addScaledVector(t,10),D.current.position.addScaledVector(t,10);break;case"a":let n=new l.Pa4(-1,0,0);V.current.target.addScaledVector(n,10),D.current.position.addScaledVector(n,10);break;case"d":let o=new l.Pa4(1,0,0);V.current.target.addScaledVector(o,10),D.current.position.addScaledVector(o,10)}A.current.update()}else if(V.current instanceof w)switch(console.log("Pointer lock movement"),e.key){case"w":O.current.y=10;break;case"s":O.current.y=-10;break;case"a":O.current.x=-10;break;case"d":O.current.x=10;break;case"Space":D.current.position.z<=10&&(O.current.z=20)}}},g=e=>{if(V.current)switch(e.key){case"w":case"s":O.current.y=0;break;case"a":case"d":O.current.x=0;break;case"Space":O.current.z=0}};return window.addEventListener("resize",$),window.addEventListener("keydown",d),window.addEventListener("keyup",g),V.current=u,_.current=0,()=>{var n;window.removeEventListener("keydown",d),window.removeEventListener("keyup",g),null===(n=r.current)||void 0===n||n.removeChild(e.domElement),t.current.dispose()}},[]);let Q=()=>{if(!h.current||!e.world||!m.current)return;let r=M(e.world,h.current);b.current=r,m.current.add(r)},ee=()=>{if(!h.current||!e.world||!m.current)return;let r=F(e.world.waterLevel,e.world.heightmap.length,h.current);z.current=r,m.current.add(r)},er=()=>{if(!b.current||!e.world||!m.current||!q.current)return;if(e.world.temple){let[r,t]=P(e.world.temple,e.world.heightmap,b.current,12);q.current=q.current.concat(r),t.forEach(e=>{q.current=q.current.concat(e)})}if(e.world.docks){let r=S(e.world.docks,e.world.heightmap,b.current);q.current=q.current.concat(r)}let r=E(e.world,b.current);q.current=q.current.concat(r),q.current.forEach(e=>m.current.add(e))},et=()=>{e.world&&m.current&&W.current&&(W.current=[],e.world.templePath&&(W.current=W.current.concat(C(e.world.templePath,e.world.heightmap))),e.world.docksPath&&(W.current=W.current.concat(C(e.world.docksPath,e.world.heightmap))),W.current.forEach(e=>{m.current.add(e)}))},en=()=>{if(!m.current||!e.world||!b.current)return;let[r,t,n]=k(e.world,b.current);I.current=[r,t,n],r&&m.current.add(r),t&&m.current.add(t),n&&m.current.add(n)},eo=()=>{m.current&&e.world&&(T.current=R(e.world.waterAccumulation,e.world.heightmap),m.current.add(T.current))},ea=()=>{m.current&&e.world&&b.current&&(Y.current=j(e.world.waterAccumulation,e.world.heightmap,e.world.waterLevel,b.current),Y.current.forEach(e=>m.current.add(e)))},ec=()=>{m.current&&e.world&&b.current&&(K.current=L(e.world.flowDirections),m.current.add(K.current))};return(0,c.useEffect)(()=>{e.displayParams.drawTerrain?Q():b.current&&m.current.remove(b.current)},[e.displayParams.drawTerrain]),(0,c.useEffect)(()=>{e.displayParams.drawWater?Q():z.current&&m.current.remove(z.current)},[e.displayParams.drawWater]),(0,c.useEffect)(()=>{e.displayParams.drawStructures?er():q.current&&q.current.forEach(e=>m.current.remove(e))},[e.displayParams.drawStructures]),(0,c.useEffect)(()=>{e.displayParams.drawRoads?et():W.current&&W.current.forEach(e=>m.current.remove(e))},[e.displayParams.drawRoads]),(0,c.useEffect)(()=>{e.displayParams.showStructureFlares?en():I.current&&I.current.forEach(e=>{e&&m.current.remove(e)})},[e.displayParams.showStructureFlares]),(0,c.useEffect)(()=>{e.displayParams.showFlowDirections?ec():K.current&&m.current.remove(K.current)},[e.displayParams.showFlowDirections]),(0,c.useEffect)(()=>{e.displayParams.showWaterAccumulation?eo():T.current&&m.current.remove(T.current)},[e.displayParams.showWaterAccumulation]),(0,c.useEffect)(()=>{e.displayParams.showTrees?ea():Y.current&&Y.current.forEach(e=>{e&&m.current.remove(e)})},[e.displayParams.showTrees]),(0,c.useEffect)(()=>{let e=new l.Mig(h.current.ambientLight);p.current=e},[e.colorsConfig.ambientLight]),(0,c.useEffect)(()=>{let e=new l.Ox3(h.current.directionalLight);f.current=e},[e.colorsConfig.directionalLight]),(0,c.useEffect)(()=>{let n;if(m.current)for(;m.current.children.length>0;)m.current.remove(m.current.children[0]);if(_.current=0,G(),A.current.enabled=!0,!r.current||!e.world||!t.current)return;g.current=new l.SUY,q.current=[],W.current=[],m.current&&(e.displayParams.drawTerrain&&Q(),e.displayParams.drawWater&&ee(),e.displayParams.drawStructures&&er(),e.displayParams.drawRoads&&et(),e.displayParams.showStructureFlares&&en(),e.displayParams.showFlowDirections&&ec(),e.displayParams.showWaterAccumulation&&eo(),e.displayParams.showTrees&&ea(),p.current&&m.current.add(p.current),f.current&&m.current.add(f.current));let a=()=>{n=requestAnimationFrame(a);let e=g.current.getDelta();if(1===_.current){o("Free Fall"),Z.current+=9.81*e,D.current.position.z-=Z.current*e;let r=v(D.current.position,b.current);r.length>0&&r[0].distance<=Z.current*e&&(D.current.position.z=5,D.current.lookAt(new l.Pa4(1,0,0)),D.current.setRotationFromEuler(new l.USm(0,0,0,"ZYX")),_.current=2,V.current=N.current,Z.current=0)}else if(2===_.current){o("Fly-Hack");let r=O.current;U.current,r.x-=10*r.x*e,r.y-=10*r.y*e,H.current&&(r.y+=10*e),B.current&&(r.y-=10*e),X.current&&(r.x-=10*e),J.current&&(r.x+=10*e),V.current.moveRight(r.x*e),V.current.moveForward(-1*r.y*e)}else 0===_.current&&(o("Free Float"),A.current.update());t.current.render(m.current,D.current)};return a(),()=>cancelAnimationFrame(n)},[e.world]),(0,a.jsx)("div",{ref:d,id:"three-container",tabIndex:0,className:"p-4 flex-1",children:(0,a.jsxs)("div",{className:"h-full justify-center",children:[(0,a.jsx)("div",{id:"fullscreen-button-container",className:"relative",children:(0,a.jsx)(y.z,{id:"fullscreen-btn",onClick:()=>{},className:"absolute top-1 right-2 z-10 p-4 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:"『』"})}),(0,a.jsx)("div",{id:"cameramode-label-container",className:"relative",children:(0,a.jsx)("div",{className:"flex p-4 absolute top-1 left-1 z-10",children:(0,a.jsxs)("span",{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:["Camera Mode: ",n]})})}),(0,a.jsx)("div",{ref:r,className:"h-full w-full bg-primary"}),(0,a.jsx)("div",{id:"buttons-container",className:"relative",children:(0,a.jsxs)("div",{className:"flex p-4 absolute bottom-1 left-1 z-10",children:[(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{D.current&&V.current&&(G(),_.current=0,D.current.updateProjectionMatrix(),A.current.reset(),A.current.enabled=!0,V.current=A.current,t.current.domElement.removeEventListener("click",()=>{V.current instanceof w&&N.current.lock()}))},children:"\uD83D\uDDFA️"}),(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{if(!D.current||!V.current||!e.world||!b.current)return;let r=new l.Pa4(e.world.townSquare.x-b.current.geometry.parameters.width/2,e.world.heightmap.length-e.world.townSquare.y-b.current.geometry.parameters.height/2,10);_.current=0,V.current=A.current,D.current.position.set(r.x,r.y,50),A.current.target.copy(r),A.current.update(),A.current.enabled=!0,t.current.domElement.removeEventListener("click",()=>{V.current instanceof w&&N.current.lock()})},children:"\uD83C\uDFD8️"}),(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{A.current.enabled=!1,_.current=1},children:"\uD83E\uDE82"}),(0,a.jsx)(y.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{A.current.enabled=!1,t.current.domElement.addEventListener("click",()=>{V.current instanceof w&&N.current.lock()}),_.current=2,V.current=N.current},children:"\uD83D\uDEE9️"})]})})]})})}}}]);