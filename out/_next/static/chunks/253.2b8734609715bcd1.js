"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[253],{8253:function(e,r,t){t.r(r),t.d(r,{default:function(){return E}});var n,a,c=t(7437),l=t(2265),o=t(7776),u=t(8938),i=t(9733),s=t(1648);let d=(e,r,t)=>{let n=e.distanceTo(r),a=new o.fHI(.5,.5,n,32),c=new o.vBJ({color:t}),l=new o.Kj0(a,c),u=new o.Pa4().addVectors(e,r).multiplyScalar(.5);l.position.copy(u);let i=new o.Pa4().subVectors(r,e).normalize(),s=new o.Pa4(0,1,0).cross(i).normalize(),d=Math.acos(new o.Pa4(0,1,0).dot(i));return l.quaternion.setFromAxisAngle(s,d),l},h=(e,r)=>{let t=r.geometry,n=new o.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.heightmap.length-e.townSquare.y]*s.Vl),a=null;if(e.docks){let r=new o.Pa4(e.docks.x-t.parameters.width/2,e.heightmap.length-e.docks.y-t.parameters.height/2,e.heightmap[e.docks.x][e.heightmap.length-e.docks.y]*s.Vl),n=new o.Pa4(r.x,r.y,r.z+10);a=d(r,n,65535)}let c=null;if(e.temple){let r=new o.Pa4(e.temple.x-t.parameters.width/2,e.heightmap.length-e.temple.y-t.parameters.height/2,e.heightmap[e.temple.x][e.heightmap.length-e.temple.y]*s.Vl),n=new o.Pa4(r.x,r.y,r.z+10);c=d(r,n,16776960)}let l=new o.Pa4(n.x,n.y,n.z+10);return[d(n,l,16711935),a,c]},w=(e,r,t,n)=>{let a=t.geometry,c=new o.Pa4(e.x-a.parameters.width/2,r.length-e.y-a.parameters.height/2,r[e.x][e.y]*s.Vl),l=new o.Wid({color:16773358,roughness:.5,metalness:.1}),u=new o.fHI(15/n,13/n,2/n,32),i=new o.Kj0(u,l);i.position.set(c.x,c.y,c.z),i.rotation.x=-Math.PI/2;let d=new o.fHI(.5/n,.5/n,10/n,32),h=12/n,w=[];for(let e=0;e<12;e++){let r=e/12*2*Math.PI,t=h*Math.cos(r)+c.x,a=h*Math.sin(r)+c.y,u=new o.Kj0(d,l);u.position.set(t,a,c.z+5/n),u.rotation.x=-Math.PI/2,w=w.concat(u)}return[i,w]},m=(e,r)=>{let t=r.geometry,n=new o.Wid({color:16773358,roughness:.5,metalness:.1}),a=new o.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.townSquare.y]*s.Vl),c=new o.DvJ(1.2,1.2,.1),l=new o.Kj0(c,n);return l.position.set(a.x,a.y,a.z),l},p=(e,r,t)=>{let n=t.geometry,a=new o.Wid({color:16773358,roughness:.5,metalness:.1}),c=new o.Pa4(e.x-n.parameters.width/2,r.length-e.y-n.parameters.height/2,r[e.x][e.y]*s.Vl),l=new o.DvJ(1.2,1.2,.1),u=new o.Kj0(l,a);return u.position.set(c.x,c.y,c.z),u},f=(e,r,t)=>{t=Math.min(Math.max(t,0),1);let n=parseInt(e.substring(1),16),a=parseInt(r.substring(1),16),c=n>>16&255,l=n>>8&255,o=255&n,u=Math.round(c+t*((a>>16&255)-c)),i=Math.round(l+t*((a>>8&255)-l)),s=Math.round(o+t*((255&a)-o));return"#".concat((u<<16|i<<8|s).toString(16).padStart(6,"0"))},g=(e,r)=>{let t=e.heightmap.length,n=new o._12(t,t,t-1,t-1),a=[];for(let c=0;c<n.attributes.position.array.length;c+=3){let l;let u=Math.floor(c/3%t),i=Math.floor(c/3/t);n.attributes.position.setZ(c/3,10*e.heightmap[u][i]),l=new o.Ilk(e.heightmap[u][i]<.001?r.terrainGradient[0]:e.heightmap[u][i]<.5?f(r.terrainGradient[1],r.terrainGradient[2],2*e.heightmap[u][i]):f(r.terrainGradient[2],r.terrainGradient[3],(e.heightmap[u][i]-.5)*2)),a.push(l.r,l.g,l.b)}n.setAttribute("color",new o.a$l(a,3)),n.computeVertexNormals();let c=new o.YBo({vertexColors:!0,flatShading:!0});return new o.Kj0(n,c)},y=(e,r)=>{let t=e.length,n=new o.Ilk(2237149),a=new o.ZAu,c=0;for(let r=0;r<t;r++)for(let n=0;n<t;n++)null!==e[r][n]&&e[r][n]>c&&(c=e[r][n]);for(let l=0;l<t;l++)for(let u=0;u<t;u++){if(null===e[l][u])continue;let i=e[l][u]/c;if(i<.05)continue;let s=new o.zf8(i,4),d=new o.vBJ({color:n}),h=new o.Kj0(s,d);h.position.set(l-t/2,t-u-t/2,10*r[l][u]+.5),a.add(h)}return a},x=e=>{let r=e.length,t=new o.ZAu;for(let n=0;n<r;n++)for(let a=0;a<r;a++){let c=e[n][a];if(null!==c){let e=s.nK[c],l=new o.Pa4(e[0],-e[1],0).normalize(),u=new o.tGC(l,new o.Pa4(n-r/2,r-a-r/2,12),1,11184895,.2,.2);t.add(u)}}return t},P=(e,r)=>{let t=new o.u9r,n=r.length,a=new Float32Array(3*e.length);e.forEach((e,t)=>{a[3*t]=e.x-n/2,a[3*t+1]=n-e.y-n/2,a[3*t+2]=10*r[e.x][e.y]+.2}),t.setAttribute("position",new o.TlE(a,3));let c=new o.nls({color:16777215,linewidth:2});return new o.x12(t,c)},b=(e,r,t)=>{let n=new o.ZAu,a=10*r[e.x][e.y]+.6+.4*t,c=Math.random()+e.x-r.length/2,l=Math.random()+(r.length-e.y)-r.length/2,u=new o.fHI(.02+.05*t,.03+.05*t,.5,6),i=new o.Wid({color:9127187}),s=new o.Kj0(u,i);s.position.set(c,l,a),s.rotation.x=-Math.PI/2,n.add(s);let d=new o.Wid({color:2263842}),h=[new o.b_z(.25+.25*t,.15+.15*t,5),new o.b_z(.2+.2*t,.18+.18*t,5),new o.b_z(.15+.15*t,.1+.1*t,5)],w=[.1+.4*t,.2+.4*t,.3+.4*t];return h.forEach((e,r)=>{let t=new o.Kj0(e,d);t.rotation.x=Math.PI/2,t.position.set(c,l,a+w[r]),n.add(t)}),n},v=(e,r)=>{let t=r.length,n=[],a=0;for(let r=0;r<t;r++)for(let n=0;n<t;n++)null!==e[r][n]&&e[r][n]>a&&(a=e[r][n]);for(let c=0;c<t;c++)for(let l=0;l<t;l++){if(r[c][l]<1e-4)continue;let t=Math.log(e[c][l]/a*(a-1)+1)/Math.log(a);t>.3&&(n=n.concat(b({x:c,y:l},r,t)),console.log("Added tree at (",c,", ",l,")"),console.log("ret = ",n))}return n};(n=a||(a={}))[n.FreeFloat=0]="FreeFloat",n[n.FreeFall=1]="FreeFall",n[n.Walking=2]="Walking";var E=e=>{let r=(0,l.useRef)(null),t=(0,l.useRef)(null);document.getElementById("fullscreen-btn");let[n,a]=(0,l.useState)(!1),d=(0,l.useRef)(null),f=(0,l.useRef)(e.colorsConfig),b=(0,l.useRef)(null),E=(0,l.useRef)(null),S=(0,l.useRef)(null),k=(0,l.useRef)(null),z=(0,l.useRef)(null),M=(0,l.useRef)(null),R=(0,l.useRef)(null),j=(0,l.useRef)(null);(0,l.useRef)(null);let C=(0,l.useRef)(0),F=(0,l.useRef)([]),A=(0,l.useRef)([]),D=(0,l.useRef)([]),V=(0,l.useRef)(null),I=(0,l.useRef)(null),N=(0,l.useRef)([]),q=()=>{M.current.fov=s.d$,M.current.aspect=s.lK,M.current.near=s.CC,M.current.far=s.wt,M.current.position.set(0,0,100)},K=(0,l.useRef)(0),W=()=>{var e,n,a;let c=null===(e=r.current)||void 0===e?void 0:e.clientWidth,l=null===(n=r.current)||void 0===n?void 0:n.clientHeight;null===(a=t.current)||void 0===a||a.setSize(c,l),M.current.aspect=c/l,M.current.updateProjectionMatrix()};(0,l.useEffect)(()=>{f.current=e.colorsConfig},[e.colorsConfig]),(0,l.useEffect)(()=>{let e=new o.CP7({antialias:!0});t.current=e,r.current.appendChild(t.current.domElement);let n=new o.xsS,a=new o.Mig(f.current.ambientLight);n.add(a),E.current=a;let c=new o.Ox3(f.current.directionalLight,100);c.position.set(50,50,50),n.add(c),S.current=c,b.current=n;let l=new o.cPb(s.d$,s.lK,s.CC,s.wt);l.position.set(0,0,100),M.current=l,W();let i=new u.z(l,t.current.domElement);i.enableDamping=!0,i.dampingFactor=.05,j.current=i;let d=e=>{if(M.current&&R.current){if(R.current instanceof u.z)switch(e.key){case"w":let r=new o.Pa4(0,1,0);R.current.target.addScaledVector(r,10),M.current.position.addScaledVector(r,10);break;case"s":let t=new o.Pa4(0,-1,0);R.current.target.addScaledVector(t,10),M.current.position.addScaledVector(t,10);break;case"a":let n=new o.Pa4(-1,0,0);R.current.target.addScaledVector(n,10),M.current.position.addScaledVector(n,10);break;case"d":let a=new o.Pa4(1,0,0);R.current.target.addScaledVector(a,10),M.current.position.addScaledVector(a,10)}j.current.update()}};return window.addEventListener("resize",W),R.current=i,C.current=0,()=>{var n;window.removeEventListener("keydown",d),null===(n=r.current)||void 0===n||n.removeChild(e.domElement),t.current.dispose()}},[]);let L=()=>{if(!f.current||!e.world||!b.current)return;let r=g(e.world,f.current);z.current=r,b.current.add(r)},T=()=>{if(!z.current||!e.world||!b.current||!A.current)return;if(e.world.temple){let[r,t]=w(e.world.temple,e.world.heightmap,z.current,12);A.current=A.current.concat(r),t.forEach(e=>{A.current=A.current.concat(e)})}if(e.world.docks){let r=p(e.world.docks,e.world.heightmap,z.current);A.current=A.current.concat(r)}let r=m(e.world,z.current);A.current=A.current.concat(r),A.current.forEach(e=>b.current.add(e))},_=()=>{e.world&&b.current&&D.current&&(D.current=[],e.world.templePath&&(D.current=D.current.concat(P(e.world.templePath,e.world.heightmap))),e.world.docksPath&&(D.current=D.current.concat(P(e.world.docksPath,e.world.heightmap))),D.current.forEach(e=>{b.current.add(e)}))},G=()=>{if(!b.current||!e.world||!z.current)return;let[r,t,n]=h(e.world,z.current);F.current=[r,t,n],r&&b.current.add(r),t&&b.current.add(t),n&&b.current.add(n)},H=()=>{b.current&&e.world&&(I.current=y(e.world.waterAccumulation,e.world.heightmap),b.current.add(I.current))},B=()=>{b.current&&e.world&&(N.current=v(e.world.waterAccumulation,e.world.heightmap),N.current.forEach(e=>b.current.add(e)))},J=()=>{b.current&&e.world&&z.current&&(V.current=x(e.world.flowDirections),b.current.add(V.current))};return(0,l.useEffect)(()=>{e.displayParams.drawTerrain?L():z.current&&b.current.remove(z.current)},[e.displayParams.drawTerrain]),(0,l.useEffect)(()=>{e.displayParams.drawStructures?T():A.current&&A.current.forEach(e=>b.current.remove(e))},[e.displayParams.drawStructures]),(0,l.useEffect)(()=>{e.displayParams.drawRoads?_():D.current&&D.current.forEach(e=>b.current.remove(e))},[e.displayParams.drawRoads]),(0,l.useEffect)(()=>{e.displayParams.showStructureFlares?G():F.current&&F.current.forEach(e=>{e&&b.current.remove(e)})},[e.displayParams.showStructureFlares]),(0,l.useEffect)(()=>{e.displayParams.showFlowDirections?J():V.current&&b.current.remove(V.current)},[e.displayParams.showFlowDirections]),(0,l.useEffect)(()=>{e.displayParams.showWaterAccumulation?H():I.current&&b.current.remove(I.current)},[e.displayParams.showWaterAccumulation]),(0,l.useEffect)(()=>{e.displayParams.showTrees?B():N.current&&N.current.forEach(e=>{e&&b.current.remove(e)})},[e.displayParams.showTrees]),(0,l.useEffect)(()=>{let e=new o.Mig(f.current.ambientLight);E.current=e},[e.colorsConfig.ambientLight]),(0,l.useEffect)(()=>{let e=new o.Ox3(f.current.directionalLight);S.current=e},[e.colorsConfig.directionalLight]),(0,l.useEffect)(()=>{let n;if(b.current)for(;b.current.children.length>0;)b.current.remove(b.current.children[0]);if(C.current=0,q(),j.current.enabled=!0,!r.current||!e.world||!t.current)return;k.current=new o.SUY,A.current=[],D.current=[],b.current&&(e.displayParams.drawTerrain&&L(),e.displayParams.drawStructures&&T(),e.displayParams.drawRoads&&_(),e.displayParams.showStructureFlares&&G(),e.displayParams.showFlowDirections&&J(),e.displayParams.showWaterAccumulation&&H(),e.displayParams.showTrees&&B(),E.current&&b.current.add(E.current),S.current&&b.current.add(S.current));let a=()=>{n=requestAnimationFrame(a);let e=k.current.getDelta();if(1===C.current){K.current+=9.81*e,M.current.position.z-=K.current*e;let r=new o.Pa4(0,0,-1),t=new o.iMs;t.set(M.current.position,r);let n=t.intersectObject(z.current);n.length>0&&n[0].distance<=K.current*e&&(M.current.position.z=5,M.current.lookAt(new o.Pa4(1,0,0)),C.current=2,K.current=0)}else j.current.update();t.current.render(b.current,M.current)};return a(),()=>cancelAnimationFrame(n)},[e.world]),(0,c.jsx)("div",{ref:d,id:"three-container",tabIndex:0,className:"p-4 flex-1",children:(0,c.jsxs)("div",{className:"h-full justify-center",children:[(0,c.jsx)("div",{id:"fullscreen-button-container",className:"relative",children:(0,c.jsx)(i.z,{id:"fullscreen-btn",onClick:()=>{},className:"absolute top-1 right-2 z-10 p-4 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:"『』"})}),(0,c.jsx)("div",{ref:r,className:"h-full w-full bg-primary"}),(0,c.jsx)("div",{id:"buttons-container",className:"relative",children:(0,c.jsxs)("div",{className:"flex p-4 absolute bottom-1 left-1 z-10",children:[(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{M.current&&R.current&&(q(),C.current=0,M.current.updateProjectionMatrix(),j.current.reset(),j.current.enabled=!0,R.current=j.current)},children:"\uD83D\uDDFA️"}),(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{if(!M.current||!R.current||!e.world||!z.current)return;let r=new o.Pa4(e.world.townSquare.x-z.current.geometry.parameters.width/2,e.world.heightmap.length-e.world.townSquare.y-z.current.geometry.parameters.height/2,10);M.current.position.set(r.x,r.y,50),j.current.target.copy(r),j.current.update()},children:"\uD83C\uDFD8️"}),(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{j.current.enabled=!1,C.current=1},children:"\uD83E\uDE82"})]})})]})})}}}]);