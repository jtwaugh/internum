"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[253],{8253:function(e,r,t){t.r(r),t.d(r,{default:function(){return x}});var n,a,c=t(7437),u=t(2265),l=t(7776),o=t(8938),i=t(9733),s=t(1648);let d=(e,r,t)=>{let n=e.distanceTo(r),a=new l.fHI(.5,.5,n,32),c=new l.vBJ({color:t}),u=new l.Kj0(a,c),o=new l.Pa4().addVectors(e,r).multiplyScalar(.5);u.position.copy(o);let i=new l.Pa4().subVectors(r,e).normalize(),s=new l.Pa4(0,1,0).cross(i).normalize(),d=Math.acos(new l.Pa4(0,1,0).dot(i));return u.quaternion.setFromAxisAngle(s,d),u},h=(e,r)=>{let t=r.geometry,n=new l.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.heightmap.length-e.townSquare.y]*s.Vl),a=new l.Pa4(e.docks.x-t.parameters.width/2,e.heightmap.length-e.docks.y-t.parameters.height/2,e.heightmap[e.docks.x][e.heightmap.length-e.docks.y]*s.Vl),c=new l.Pa4(e.temple.x-t.parameters.width/2,e.heightmap.length-e.temple.y-t.parameters.height/2,e.heightmap[e.temple.x][e.heightmap.length-e.temple.y]*s.Vl),u=new l.Pa4(n.x,n.y,n.z+10),o=new l.Pa4(a.x,a.y,a.z+10),i=new l.Pa4(c.x,c.y,c.z+10);return[d(n,u,16711935),d(a,o,65535),d(c,i,16776960)]},w=(e,r,t)=>{let n=r.geometry,a=new l.Pa4(e.temple.x-n.parameters.width/2,e.heightmap.length-e.temple.y-n.parameters.height/2,e.heightmap[e.temple.x][e.temple.y]*s.Vl),c=new l.Wid({color:16773358,roughness:.5,metalness:.1}),u=new l.fHI(15/t,13/t,2/t,32),o=new l.Kj0(u,c);o.position.set(a.x,a.y,a.z),o.rotation.x=-Math.PI/2;let i=new l.fHI(.5/t,.5/t,10/t,32),d=12/t,h=[];for(let e=0;e<12;e++){let r=e/12*2*Math.PI,n=d*Math.cos(r)+a.x,u=d*Math.sin(r)+a.y,o=new l.Kj0(i,c);o.position.set(n,u,a.z+5/t),o.rotation.x=-Math.PI/2,h=h.concat(o)}return[o,h]},p=(e,r)=>{let t=r.geometry,n=new l.Wid({color:16773358,roughness:.5,metalness:.1}),a=new l.Pa4(e.townSquare.x-t.parameters.width/2,e.heightmap.length-e.townSquare.y-t.parameters.height/2,e.heightmap[e.townSquare.x][e.townSquare.y]*s.Vl),c=new l.DvJ(1.2,1.2,.1),u=new l.Kj0(c,n);return u.position.set(a.x,a.y,a.z),u},m=(e,r,t)=>{t=Math.min(Math.max(t,0),1);let n=parseInt(e.substring(1),16),a=parseInt(r.substring(1),16),c=n>>16&255,u=n>>8&255,l=255&n,o=Math.round(c+t*((a>>16&255)-c)),i=Math.round(u+t*((a>>8&255)-u)),s=Math.round(l+t*((255&a)-l));return"#".concat((o<<16|i<<8|s).toString(16).padStart(6,"0"))},f=(e,r)=>{let t=e.heightmap.length,n=new l._12(t,t,t-1,t-1),a=[];for(let c=0;c<n.attributes.position.array.length;c+=3){let u;let o=Math.floor(c/3%t),i=Math.floor(c/3/t);n.attributes.position.setZ(c/3,10*e.heightmap[o][i]),u=new l.Ilk(e.heightmap[o][i]<.001?r.terrainGradient[0]:e.heightmap[o][i]<.5?m(r.terrainGradient[1],r.terrainGradient[2],2*e.heightmap[o][i]):m(r.terrainGradient[2],r.terrainGradient[3],(e.heightmap[o][i]-.5)*2)),a.push(u.r,u.g,u.b)}n.setAttribute("color",new l.a$l(a,3)),n.computeVertexNormals();let c=new l.YBo({vertexColors:!0,flatShading:!0});return new l.Kj0(n,c)},g=e=>{let r=e.length,t=new l.Ilk(2237149),n=new l.ZAu,a=0;for(let t=0;t<r;t++)for(let n=0;n<r;n++)null!==e[t][n]&&e[t][n]>a&&(a=e[t][n]);for(let c=0;c<r;c++)for(let u=0;u<r;u++){if(null===e[c][u])continue;let o=e[c][u]/a;if(o<.05)continue;let i=new l.zf8(o,4),s=new l.vBJ({color:t}),d=new l.Kj0(i,s);d.position.set(c-r/2,r-u-r/2,10),n.add(d)}return n},y=e=>{let r=e.length,t=new l.ZAu;for(let n=0;n<r;n++)for(let a=0;a<r;a++){let c=e[n][a];if(null!==c){let e=s.nK[c],u=new l.Pa4(e[0],-e[1],0).normalize(),o=new l.tGC(u,new l.Pa4(n-r/2,r-a-r/2,12),1,11184895,.2,.2);t.add(o)}}return t};(n=a||(a={}))[n.FreeFloat=0]="FreeFloat",n[n.FreeFall=1]="FreeFall",n[n.Walking=2]="Walking";var x=e=>{let r=(0,u.useRef)(null),t=(0,u.useRef)(null);document.getElementById("fullscreen-btn");let[n,a]=(0,u.useState)(!1),d=(0,u.useRef)(null),m=(0,u.useRef)(e.colorsConfig),x=(0,u.useRef)(null),b=(0,u.useRef)(null),P=(0,u.useRef)(null),v=(0,u.useRef)(null),S=(0,u.useRef)(null),k=(0,u.useRef)(null),E=(0,u.useRef)(null),z=(0,u.useRef)(null);(0,u.useRef)(null);let C=(0,u.useRef)(0),j=(0,u.useRef)([]),F=(0,u.useRef)([]),R=(0,u.useRef)(null),M=(0,u.useRef)(null),D=()=>{k.current.fov=s.d$,k.current.aspect=s.lK,k.current.near=s.CC,k.current.far=s.wt,k.current.position.set(0,0,100)},V=(0,u.useRef)(0),A=()=>{var e,n,a;let c=null===(e=r.current)||void 0===e?void 0:e.clientWidth,u=null===(n=r.current)||void 0===n?void 0:n.clientHeight;null===(a=t.current)||void 0===a||a.setSize(c,u),k.current.aspect=c/u,k.current.updateProjectionMatrix()};(0,u.useEffect)(()=>{m.current=e.colorsConfig},[e.colorsConfig]),(0,u.useEffect)(()=>{let e=new l.CP7({antialias:!0});t.current=e,r.current.appendChild(t.current.domElement);let n=new l.xsS,a=new l.Mig(m.current.ambientLight);n.add(a),b.current=a;let c=new l.Ox3(m.current.directionalLight,100);c.position.set(50,50,50),n.add(c),P.current=c,x.current=n;let u=new l.cPb(s.d$,s.lK,s.CC,s.wt);u.position.set(0,0,100),k.current=u,A();let i=new o.z(u,t.current.domElement);i.enableDamping=!0,i.dampingFactor=.05,z.current=i;let d=e=>{if(k.current&&E.current){if(E.current instanceof o.z)switch(e.key){case"w":let r=new l.Pa4(0,1,0);E.current.target.addScaledVector(r,10),k.current.position.addScaledVector(r,10);break;case"s":let t=new l.Pa4(0,-1,0);E.current.target.addScaledVector(t,10),k.current.position.addScaledVector(t,10);break;case"a":let n=new l.Pa4(-1,0,0);E.current.target.addScaledVector(n,10),k.current.position.addScaledVector(n,10);break;case"d":let a=new l.Pa4(1,0,0);E.current.target.addScaledVector(a,10),k.current.position.addScaledVector(a,10)}z.current.update()}};return window.addEventListener("resize",A),E.current=i,C.current=0,()=>{var n;window.removeEventListener("keydown",d),null===(n=r.current)||void 0===n||n.removeChild(e.domElement),t.current.dispose()}},[]);let N=()=>{if(!m.current||!e.world||!x.current)return;let r=f(e.world,m.current);S.current=r,x.current.add(r)},q=()=>{if(!S.current||!e.world||!x.current||!F.current)return;let[r,t]=w(e.world,S.current,12);F.current=F.current.concat(r),t.forEach(e=>{F.current=F.current.concat(e)});let n=p(e.world,S.current);F.current=F.current.concat(n),F.current.forEach(e=>x.current.add(e))},I=()=>{if(!x.current||!e.world||!S.current)return;let[r,t,n]=h(e.world,S.current);j.current=[r,t,n],x.current.add(r),x.current.add(t),x.current.add(n)},K=()=>{x.current&&e.world&&(M.current=g(e.world.waterAccumulation),x.current.add(M.current))},L=()=>{x.current&&e.world&&S.current&&(R.current=y(e.world.flowDirections),x.current.add(R.current))};return(0,u.useEffect)(()=>{e.displayParams.drawTerrain?N():S.current&&x.current.remove(S.current)},[e.displayParams.drawTerrain]),(0,u.useEffect)(()=>{e.displayParams.drawStructures?q():F.current&&F.current.forEach(e=>x.current.remove(e))},[e.displayParams.drawStructures]),(0,u.useEffect)(()=>{e.displayParams.showStructureFlares?I():j.current&&j.current.forEach(e=>{x.current.remove(e)})},[e.displayParams.showStructureFlares]),(0,u.useEffect)(()=>{e.displayParams.showFlowDirections?L():R.current&&x.current.remove(R.current)},[e.displayParams.showFlowDirections]),(0,u.useEffect)(()=>{e.displayParams.showWaterAccumulation?K():M.current&&x.current.remove(M.current)},[e.displayParams.showWaterAccumulation]),(0,u.useEffect)(()=>{let e=new l.Mig(m.current.ambientLight);b.current=e},[e.colorsConfig.ambientLight]),(0,u.useEffect)(()=>{let e=new l.Ox3(m.current.directionalLight);P.current=e},[e.colorsConfig.directionalLight]),(0,u.useEffect)(()=>{let n;if(x.current)for(;x.current.children.length>0;)x.current.remove(x.current.children[0]);if(C.current=0,D(),z.current.enabled=!0,!r.current||!e.world||!t.current)return;v.current=new l.SUY,F.current=[],x.current&&(e.displayParams.drawTerrain&&N(),e.displayParams.drawStructures&&q(),e.displayParams.showStructureFlares&&I(),e.displayParams.showFlowDirections&&L(),e.displayParams.showWaterAccumulation&&K(),b.current&&x.current.add(b.current),P.current&&x.current.add(P.current));let a=()=>{n=requestAnimationFrame(a);let e=v.current.getDelta();if(1===C.current){V.current+=9.81*e,k.current.position.z-=V.current*e;let r=new l.Pa4(0,0,-1),t=new l.iMs;t.set(k.current.position,r);let n=t.intersectObject(S.current);n.length>0&&n[0].distance<=V.current*e&&(k.current.position.z=5,k.current.lookAt(new l.Pa4(1,0,0)),C.current=2,V.current=0)}else z.current.update();t.current.render(x.current,k.current)};return a(),()=>cancelAnimationFrame(n)},[e.world]),(0,c.jsx)("div",{ref:d,id:"three-container",tabIndex:0,className:"p-4 flex-1",children:(0,c.jsxs)("div",{className:"h-full justify-center",children:[(0,c.jsx)("div",{id:"fullscreen-button-container",className:"relative",children:(0,c.jsx)(i.z,{id:"fullscreen-btn",onClick:()=>{},className:"absolute top-1 right-2 z-10 p-4 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:"『』"})}),(0,c.jsx)("div",{ref:r,className:"h-full w-full bg-primary"}),(0,c.jsx)("div",{id:"buttons-container",className:"relative",children:(0,c.jsxs)("div",{className:"flex p-4 absolute bottom-1 left-1 z-10",children:[(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{k.current&&E.current&&(D(),C.current=0,k.current.updateProjectionMatrix(),z.current.reset(),z.current.enabled=!0,E.current=z.current)},children:"\uD83D\uDDFA️"}),(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{if(!k.current||!E.current||!e.world||!S.current)return;let r=new l.Pa4(e.world.townSquare.x-S.current.geometry.parameters.width/2,e.world.heightmap.length-e.world.townSquare.y-S.current.geometry.parameters.height/2,10);k.current.position.set(r.x,r.y,50),z.current.target.copy(r),z.current.update()},children:"\uD83C\uDFD8️"}),(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{z.current.enabled=!1,C.current=1},children:"\uD83E\uDE82"})]})})]})})}}}]);