"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[253],{8253:function(e,t,r){r.r(t),r.d(t,{default:function(){return f}});var n,a,c=r(7437),l=r(2265),o=r(7776),u=r(8938),i=r(9733),s=r(1648);let d=(e,t,r)=>{let n=e.distanceTo(t),a=new o.fHI(.5,.5,n,32),c=new o.vBJ({color:r}),l=new o.Kj0(a,c),u=new o.Pa4().addVectors(e,t).multiplyScalar(.5);l.position.copy(u);let i=new o.Pa4().subVectors(t,e).normalize(),s=new o.Pa4(0,1,0).cross(i).normalize(),d=Math.acos(new o.Pa4(0,1,0).dot(i));return l.quaternion.setFromAxisAngle(s,d),l},h=(e,t)=>{let r=t.geometry,n=new o.Pa4(e.townSquare.x-r.parameters.width/2,e.heightmap.length-e.townSquare.y-r.parameters.height/2,e.heightmap[e.townSquare.x][e.heightmap.length-e.townSquare.y]*s.Vl),a=new o.Pa4(e.docks.x-r.parameters.width/2,e.heightmap.length-e.docks.y-r.parameters.height/2,e.heightmap[e.docks.x][e.heightmap.length-e.docks.y]*s.Vl),c=new o.Pa4(e.temple.x-r.parameters.width/2,e.heightmap.length-e.temple.y-r.parameters.height/2,e.heightmap[e.temple.x][e.heightmap.length-e.temple.y]*s.Vl),l=new o.Pa4(n.x,n.y,n.z+10),u=new o.Pa4(a.x,a.y,a.z+10),i=new o.Pa4(c.x,c.y,c.z+10);return[d(n,l,16711935),d(a,u,65535),d(c,i,16776960)]},p=(e,t,r)=>{let n=t.geometry,a=new o.Pa4(e.temple.x-n.parameters.width/2,e.heightmap.length-e.temple.y-n.parameters.height/2,e.heightmap[e.temple.x][e.temple.y]*s.Vl),c=new o.Wid({color:16773358,roughness:.5,metalness:.1}),l=new o.fHI(15/r,13/r,2/r,32),u=new o.Kj0(l,c);u.position.set(a.x,a.y,a.z),u.rotation.x=-Math.PI/2;let i=new o.fHI(.5/r,.5/r,10/r,32),d=12/r,h=[];for(let e=0;e<12;e++){let t=e/12*2*Math.PI,n=d*Math.cos(t)+a.x,l=d*Math.sin(t)+a.y,u=new o.Kj0(i,c);u.position.set(n,l,a.z+5/r),u.rotation.x=-Math.PI/2,h=h.concat(u)}return[u,h]},g=(e,t)=>{let r=t.geometry,n=new o.Wid({color:16773358,roughness:.5,metalness:.1}),a=new o.Pa4(e.townSquare.x-r.parameters.width/2,e.heightmap.length-e.townSquare.y-r.parameters.height/2,e.heightmap[e.townSquare.x][e.townSquare.y]*s.Vl),c=new o.DvJ(1.2,1.2,.1),l=new o.Kj0(c,n);return l.position.set(a.x,a.y,a.z),l},m=(e,t,r)=>{r=Math.min(Math.max(r,0),1);let n=parseInt(e.substring(1),16),a=parseInt(t.substring(1),16),c=n>>16&255,l=n>>8&255,o=255&n,u=Math.round(c+r*((a>>16&255)-c)),i=Math.round(l+r*((a>>8&255)-l)),s=Math.round(o+r*((255&a)-o));return"#".concat((u<<16|i<<8|s).toString(16).padStart(6,"0"))},w=(e,t)=>{console.log(t);let r=e.heightmap.length,n=new o._12(r,r,r-1,r-1),a=[];for(let c=0;c<n.attributes.position.array.length;c+=3){let l;let u=Math.floor(c/3%r),i=Math.floor(c/3/r);n.attributes.position.setZ(c/3,10*e.heightmap[u][i]),l=new o.Ilk(e.heightmap[u][i]<.001?t.terrainGradient[0]:e.heightmap[u][i]<.5?m(t.terrainGradient[1],t.terrainGradient[2],2*e.heightmap[u][i]):m(t.terrainGradient[2],t.terrainGradient[3],(e.heightmap[u][i]-.5)*2)),a.push(l.r,l.g,l.b)}n.setAttribute("color",new o.a$l(a,3)),n.computeVertexNormals();let c=new o.YBo({vertexColors:!0,flatShading:!0});return new o.Kj0(n,c)};(n=a||(a={}))[n.FreeFloat=0]="FreeFloat",n[n.FreeFall=1]="FreeFall",n[n.Walking=2]="Walking";var f=e=>{let t=(0,l.useRef)(null),r=(0,l.useRef)(null);document.getElementById("fullscreen-btn");let[n,a]=(0,l.useState)(!1),d=(0,l.useRef)(null),m=(0,l.useRef)(e.colorsConfig),f=(0,l.useRef)(null),x=(0,l.useRef)(null),b=(0,l.useRef)(null),y=(0,l.useRef)(null),v=(0,l.useRef)(null),P=(0,l.useRef)(null),S=(0,l.useRef)(null),k=(0,l.useRef)(null);(0,l.useRef)(null);let C=(0,l.useRef)(0),z=(0,l.useRef)(null),j=()=>{P.current.fov=s.d$,P.current.aspect=s.lK,P.current.near=s.CC,P.current.far=s.wt,P.current.position.set(0,0,100)},E=(0,l.useRef)(0),M=()=>{var e,n,a;let c=null===(e=t.current)||void 0===e?void 0:e.clientWidth,l=null===(n=t.current)||void 0===n?void 0:n.clientHeight;null===(a=r.current)||void 0===a||a.setSize(c,l),P.current.aspect=c/l,P.current.updateProjectionMatrix()};return(0,l.useEffect)(()=>{m.current=e.colorsConfig,console.log(e.colorsConfig)},[e.colorsConfig]),(0,l.useEffect)(()=>{let e=new o.CP7({antialias:!0});r.current=e,t.current.appendChild(r.current.domElement);let n=new o.xsS,a=new o.Mig(m.current.ambientLight);n.add(a),x.current=a;let c=new o.Ox3(m.current.directionalLight,100);c.position.set(50,50,50),n.add(c),b.current=c,f.current=n;let l=new o.cPb(s.d$,s.lK,s.CC,s.wt);l.position.set(0,0,100),P.current=l,M();let i=new u.z(l,r.current.domElement);i.enableDamping=!0,i.dampingFactor=.05,k.current=i;let d=e=>{if(P.current&&S.current){if(S.current instanceof u.z)switch(e.key){case"w":let t=new o.Pa4(0,1,0);S.current.target.addScaledVector(t,10),P.current.position.addScaledVector(t,10);break;case"s":let r=new o.Pa4(0,-1,0);S.current.target.addScaledVector(r,10),P.current.position.addScaledVector(r,10);break;case"a":let n=new o.Pa4(-1,0,0);S.current.target.addScaledVector(n,10),P.current.position.addScaledVector(n,10);break;case"d":let a=new o.Pa4(1,0,0);S.current.target.addScaledVector(a,10),P.current.position.addScaledVector(a,10)}k.current.update()}};return window.addEventListener("resize",M),S.current=i,C.current=0,()=>{var n;window.removeEventListener("keydown",d),null===(n=t.current)||void 0===n||n.removeChild(e.domElement),r.current.dispose()}},[]),(0,l.useEffect)(()=>{if(f.current&&e.world&&v.current){if(e.displayParams.showStructureFlares){let[t,r,n]=h(e.world,v.current);z.current=[t,r,n],f.current.add(t),f.current.add(r),f.current.add(n)}else z.current.forEach(e=>{f.current.remove(e)})}},[e.displayParams.showStructureFlares]),(0,l.useEffect)(()=>{let e=new o.Mig(m.current.ambientLight);x.current=e},[e.colorsConfig.ambientLight]),(0,l.useEffect)(()=>{let e=new o.Ox3(m.current.directionalLight);b.current=e},[e.colorsConfig.directionalLight]),(0,l.useEffect)(()=>{let n;if(f.current)for(;f.current.children.length>0;)f.current.remove(f.current.children[0]);if(C.current=0,j(),k.current.enabled=!0,!t.current||!e.world||!r.current)return;if(y.current=new o.SUY,e.world.heightmap&&f.current){console.log(m.current);let t=w(e.world,m.current);v.current=t,f.current.add(t);let[r,n]=p(e.world,t,12);f.current.add(r),n.forEach(e=>{f.current.add(e)});let a=g(e.world,t);f.current.add(a),x.current&&f.current.add(x.current),b.current&&f.current.add(b.current)}let a=()=>{n=requestAnimationFrame(a);let e=y.current.getDelta();if(1===C.current){E.current+=9.81*e,P.current.position.z-=E.current*e;let t=new o.Pa4(0,0,-1),r=new o.iMs;r.set(P.current.position,t);let n=r.intersectObject(v.current);n.length>0&&n[0].distance<=E.current*e&&(P.current.position.z=5,P.current.lookAt(new o.Pa4(1,0,0)),C.current=2,E.current=0)}else k.current.update();r.current.render(f.current,P.current)};return a(),()=>cancelAnimationFrame(n)},[e.world]),(0,c.jsx)("div",{ref:d,id:"three-container",tabIndex:0,className:"p-4 flex-1",children:(0,c.jsxs)("div",{className:"h-full justify-center",children:[(0,c.jsx)("div",{id:"fullscreen-button-container",className:"relative",children:(0,c.jsx)(i.z,{id:"fullscreen-btn",onClick:()=>{},className:"absolute top-1 right-2 z-10 p-4 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",children:"『』"})}),(0,c.jsx)("div",{ref:t,className:"h-full w-full bg-primary"}),(0,c.jsx)("div",{id:"buttons-container",className:"relative",children:(0,c.jsxs)("div",{className:"flex p-4 absolute bottom-1 left-1 z-10",children:[(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{P.current&&S.current&&(j(),C.current=0,P.current.updateProjectionMatrix(),k.current.reset(),k.current.enabled=!0,S.current=k.current)},children:"\uD83D\uDDFA️"}),(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{if(!P.current||!S.current||!e.world||!v.current)return;let t=new o.Pa4(e.world.townSquare.x-v.current.geometry.parameters.width/2,e.world.heightmap.length-e.world.townSquare.y-v.current.geometry.parameters.height/2,10);P.current.position.set(t.x,t.y,50),k.current.target.copy(t),k.current.update()},children:"\uD83C\uDFD8️"}),(0,c.jsx)(i.z,{className:"px-4 py-2 bg-black bg-opacity-50 text-white border-none cursor-pointer text-sm hover:bg-opacity-70",onClick:()=>{k.current.enabled=!1,C.current=1,console.log("Free fall")},children:"\uD83E\uDE82"})]})})]})})}}}]);